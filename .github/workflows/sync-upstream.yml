# Workflow åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢
name: Sync Upstream

# è§¦å‘æ¡ä»¶ï¼šå®šä¹‰ä½•æ—¶è¿è¡Œè¿™ä¸ª workflow
on:
  # å®šæ—¶è§¦å‘ï¼šä½¿ç”¨ cron è¡¨è¾¾å¼
  schedule:
    # cron æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
    # '0 * * * *' è¡¨ç¤ºæ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿè¿è¡Œï¼ˆå³æ•´ç‚¹è¿è¡Œï¼‰
    # ä¾‹å¦‚ï¼š00:00, 01:00, 02:00, ..., 23:00
    - cron: '0 * * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢å¯ä»¥æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:

# å®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡
jobs:
  # ä»»åŠ¡åç§°ï¼šsync
  sync:
    # è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu Linux
    runs-on: ubuntu-latest
    
    # æƒé™é…ç½®
    permissions:
      contents: write      # å…è®¸æ¨é€ä»£ç 
      pull-requests: write # å…è®¸åˆ›å»º PR
    
    # ç­–ç•¥é…ç½®ï¼šå®šä¹‰å¦‚ä½•è¿è¡Œå¤šä¸ªä»»åŠ¡å®ä¾‹
    strategy:
      # çŸ©é˜µç­–ç•¥ï¼šä¸ºæ¯ä¸ªåˆ†æ”¯åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ä»»åŠ¡å®ä¾‹
      matrix:
        # å®šä¹‰è¦åŒæ­¥çš„åˆ†æ”¯åˆ—è¡¨
        branch:
          - main  # ä¸»åˆ†æ”¯
          - feat/upgrade-vertex-sdk-for-global-endpoint-claude  # åŠŸèƒ½åˆ†æ”¯
      
      # fail-fast: false è¡¨ç¤ºä¸€ä¸ªåˆ†æ”¯å¤±è´¥ä¸ä¼šå–æ¶ˆå…¶ä»–åˆ†æ”¯çš„æ‰§è¡Œ
      # è¿™æ ·å¯ä»¥ç¡®ä¿æ‰€æœ‰åˆ†æ”¯éƒ½ä¼šå°è¯•åŒæ­¥ï¼Œäº’ä¸å½±å“
      fail-fast: false
    
    # å®šä¹‰æ‰§è¡Œæ­¥éª¤
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout branch
        # ä½¿ç”¨ GitHub å®˜æ–¹çš„ checkout actionï¼ˆç‰ˆæœ¬ 4ï¼‰
        uses: actions/checkout@v4
        with:
          # æ£€å‡ºå½“å‰çŸ©é˜µä¸­çš„åˆ†æ”¯
          ref: ${{ matrix.branch }}
          
          # è·å–å®Œæ•´çš„ git å†å²è®°å½•ï¼ˆè€Œä¸æ˜¯æµ…å…‹éš†ï¼‰
          # è¿™å¯¹äºåˆå¹¶æ“ä½œæ˜¯å¿…éœ€çš„
          fetch-depth: 0
          
          # ä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ token è¿›è¡Œèº«ä»½éªŒè¯
          # è¿™ä¸ª token æœ‰æƒé™æ¨é€åˆ°ä»“åº“
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤ 2ï¼šé…ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Configure Git
        run: |
          # è®¾ç½® Git æäº¤è€…åç§°ä¸º GitHub Actions æœºå™¨äºº
          git config user.name "github-actions[bot]"
          
          # è®¾ç½® Git æäº¤è€…é‚®ç®±
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # æ­¥éª¤ 3ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æœ€æ–°ä»£ç 
      - name: Add upstream remote
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“ä¸º remoteï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ï¼‰
          # || true è¡¨ç¤ºå³ä½¿å‘½ä»¤å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œ
          git remote add upstream https://github.com/cline/cline.git || true
          
          # ä»ä¸Šæ¸¸ä»“åº“è·å–æœ€æ–°çš„ä»£ç 
          git fetch upstream
      
      # æ­¥éª¤ 4ï¼šæ‰§è¡ŒåŒæ­¥æ“ä½œ
      - name: Sync with upstream
        # ç»™è¿™ä¸ªæ­¥éª¤è®¾ç½®ä¸€ä¸ª IDï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¼•ç”¨
        id: sync
        run: |
          # å°†å½“å‰åˆ†æ”¯åä¿å­˜åˆ°å˜é‡ä¸­
          BRANCH="${{ matrix.branch }}"
          
          # è¾“å‡ºæ­£åœ¨åŒæ­¥çš„åˆ†æ”¯å
          echo "Syncing branch: $BRANCH"
          
          # å°è¯•åˆå¹¶ä¸Šæ¸¸çš„ main åˆ†æ”¯
          if git merge upstream/main --no-edit; then
            # å¦‚æœåˆå¹¶æˆåŠŸï¼ˆæ²¡æœ‰å†²çªï¼‰
            
            # è¾“å‡ºæˆåŠŸæ¶ˆæ¯
            echo "Successfully merged upstream/main into $BRANCH"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ workflow æ–‡ä»¶çš„æ›´æ”¹
            if git diff --name-only HEAD~1 HEAD | grep -q "^\.github/workflows/"; then
              echo "âš ï¸ Detected changes in .github/workflows/ directory"
              echo "âš ï¸ Reverting workflow changes to avoid permission issues"
              
              # æ¢å¤ workflow æ–‡ä»¶åˆ°åˆå¹¶å‰çš„çŠ¶æ€
              git checkout HEAD~1 -- .github/workflows/ || true
              
              # å¦‚æœæœ‰æ›´æ”¹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤
              if ! git diff --quiet; then
                git add .github/workflows/
                git commit -m "chore: revert workflow changes from upstream sync"
              fi
            fi
            
            # å°†åˆå¹¶åçš„ä»£ç æ¨é€åˆ°ä½ çš„ fork ä»“åº“
            git push origin $BRANCH
            
            # è¾“å‡ºå®Œæˆæ¶ˆæ¯
            echo "âœ… Sync completed successfully for $BRANCH!"
            
            # è®¾ç½®è¾“å‡ºå˜é‡ï¼Œè¡¨ç¤ºåŒæ­¥æˆåŠŸ
            echo "success=true" >> $GITHUB_OUTPUT
          else
            # å¦‚æœåˆå¹¶å¤±è´¥ï¼ˆæœ‰å†²çªï¼‰
            
            # è¾“å‡ºè­¦å‘Šæ¶ˆæ¯
            echo "âš ï¸ Merge conflict detected in $BRANCH"
            
            # ä¸­æ­¢åˆå¹¶æ“ä½œï¼Œæ¢å¤åˆ°åˆå¹¶å‰çš„çŠ¶æ€
            git merge --abort
            
            # è®¾ç½®è¾“å‡ºå˜é‡ï¼Œè¡¨ç¤ºåŒæ­¥å¤±è´¥
            echo "success=false" >> $GITHUB_OUTPUT
            
            # é€€å‡ºå¹¶è¿”å›é”™è¯¯ä»£ç  1ï¼Œè§¦å‘ failure() æ¡ä»¶
            exit 1
          fi
      
      # æ­¥éª¤ 5ï¼šå¦‚æœæœ‰å†²çªï¼Œåˆ›å»º Pull Request
      # if: failure() è¡¨ç¤ºåªæœ‰åœ¨å‰é¢çš„æ­¥éª¤å¤±è´¥æ—¶æ‰æ‰§è¡Œ
      - name: Create Pull Request on conflict
        if: failure()
        
        # ä½¿ç”¨ç¬¬ä¸‰æ–¹ action æ¥åˆ›å»º PR
        uses: peter-evans/create-pull-request@v6
        with:
          # ä½¿ç”¨ GitHub token è¿›è¡Œèº«ä»½éªŒè¯
          token: ${{ secrets.GITHUB_TOKEN }}
          
          # PR çš„æäº¤æ¶ˆæ¯
          commit-message: "chore: sync ${{ matrix.branch }} with upstream"
          
          # PR çš„æ ‡é¢˜ï¼ŒåŒ…å«åˆ†æ”¯å
          title: "ğŸ”„ Sync ${{ matrix.branch }} with upstream (manual merge required)"
          
          # PR çš„æè¿°å†…å®¹ï¼ˆä½¿ç”¨å¤šè¡Œå­—ç¬¦ä¸²ï¼‰
          body: |
            è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“åˆ° `${{ matrix.branch }}` åˆ†æ”¯æ—¶æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚
            
            **åˆ†æ”¯**: `${{ matrix.branch }}`  
            **ä¸Šæ¸¸ä»“åº“**: https://github.com/cline/cline
            
            ### å¦‚ä½•è§£å†³å†²çª
            
            ```bash
            # åˆ‡æ¢åˆ°å†²çªåˆ†æ”¯
            git checkout ${{ matrix.branch }}
            git pull origin ${{ matrix.branch }}
            
            # æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼ˆå¦‚æœè¿˜æ²¡æ·»åŠ ï¼‰
            git remote add upstream https://github.com/cline/cline.git
            git fetch upstream
            
            # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
            git merge upstream/main
            
            # è§£å†³å†²çªå
            git add .
            git commit -m "chore: resolve merge conflicts with upstream"
            git push origin ${{ matrix.branch }}
            ```
            
            è§£å†³å†²çªåè¯·å…³é—­æ­¤ PRã€‚
          
          # PR ä½¿ç”¨çš„åˆ†æ”¯åï¼ŒåŒ…å«åŸåˆ†æ”¯åä»¥é¿å…å†²çª
          branch: sync-${{ matrix.branch }}-conflict
          
          # PR åˆå¹¶æˆ–å…³é—­åè‡ªåŠ¨åˆ é™¤è¿™ä¸ªä¸´æ—¶åˆ†æ”¯
          delete-branch: true
